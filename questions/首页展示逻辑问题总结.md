# 首页文章展示逻辑问题总结

## 问题描述

首页需要动态展示4篇文章，按以下优先级排序：
1. **pin 属性优先**（置顶文章）
2. **日期降序**（最新文章）
3. **固定展示4篇**

例如：
- 若有 3 篇 pin 文章 → 展示 3 pin + 1 最新
- 若有 2 篇 pin 文章 → 展示 2 pin + 2 最新
- 若有 1 篇 pin 文章 → 展示 1 pin + 3 最新
- 若无 pin 文章 → 展示 4 篇最新

## 以前的实现方式（不可行）

### 方式一：硬编码静态 HTML

**问题根源：**
- 首页 `home.html` 中直接硬编码了 4 篇文章的 HTML
- 每次新增/修改文章都需要手动更新 `home.html`
- 无法动态读取文章的 front matter（pin、date 等属性）
- MkDocs 的 Jinja2 模板无法直接访问 Markdown 文件的 front matter

**为什么不行：**
```html
<!-- 硬编码方式 - 无法动态排序 -->
<article>
    <h3><a href="/posts/welcome/">使用 Tailwind CSS 构建现代化博客主题</a></h3>
    <p>2026-01-05 | 前端开发</p>
</article>
<article>
    <h3><a href="/posts/mkdocs-guide/">MkDocs 自定义主题开发指南</a></h3>
    <p>2025-12-30 | 开发工具</p>
</article>
<!-- ... 手动维护，无法按 pin 排序 -->
```

### 方式二：尝试使用 MkDocs 变量（不支持）

**问题根源：**
- MkDocs 的 `pages` 变量只包含导航中的页面
- 无法遍历 `docs/posts/` 下的所有文章
- 无法访问每篇文章的 front matter 属性

**为什么不行：**
```jinja2
{# 期望的语法 - 但 MkDocs 不支持 #}
{% for page in pages if page.url.startswith('/posts/') %}
    {{ page.meta.pin }}  <!-- ❌ 无法访问 -->
    {{ page.meta.date }}  <!-- ❌ 无法访问 -->
{% endfor %}
```

## 新的实现方式（可行）

### 核心思路：构建时生成 JSON + 前端动态加载

```
┌─────────────────┐
│  MkDocs 构建    │
│  (hooks.py)     │
└────────┬────────┘
         │
         ├─ 1. 遍历 docs/posts/*.md
         ├─ 2. 解析 front matter (YAML)
         ├─ 3. 提取 pin、date、tags 等
         ├─ 4. 生成 articles.json
         │
         ▼
┌─────────────────┐
│ articles.json   │  ← 所有文章的元数据
│  - title        │
│  - date         │
│  - pin          │
│  - category     │
│  - tags         │
│  - url          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  首页 JS        │
│  (home.html)    │
└────────┬────────┘
         │
         ├─ 1. fetch articles.json
         ├─ 2. 排序（pin 优先，再按日期）
         ├─ 3. 取前 4 篇
         ├─ 4. 动态渲染 HTML
         │
         ▼
      首页展示
```

### 实现细节

#### 1. hooks.py - 构建时生成 JSON

```python
def generate_articles_json(config):
    """遍历 posts 目录，生成 articles.json"""
    docs_dir = Path(config['docs_dir'])
    posts_dir = docs_dir / 'posts'
    
    articles = []
    
    # 遍历所有 .md 文件（排除 index.md）
    for md_file in posts_dir.glob('*.md'):
        if md_file.name == 'index.md':
            continue
        
        # 解析 front matter
        article = parse_article(md_file)
        articles.append(article)
    
    # 写入 JSON
    output_path = posts_dir / 'articles.json'
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(articles, f, ensure_ascii=False, indent=2)
```

#### 2. 解析 Front Matter

```python
def parse_article(md_file: Path) -> dict:
    """解析单篇文章的 front matter 和内容"""
    content = md_file.read_text(encoding='utf-8')
    
    # 提取 YAML front matter
    if content.startswith('---'):
        parts = content.split('---', 2)
        front_matter = yaml.safe_load(parts[1]) or {}
        body = parts[2].strip()
    
    return {
        'title': front_matter.get('title', slug),
        'date': str(front_matter.get('date', '2000-01-01')),
        'category': front_matter.get('category', '未分类'),
        'tags': front_matter.get('tags', []),
        'pin': front_matter.get('pin', False),  # ← 关键属性
        'url': f"/posts/{slug}/",
        'content': extract_summary(body)
    }
```

#### 3. 前端排序逻辑

```javascript
// home.html 中的 JavaScript
const response = await fetch('/posts/articles.json');
const articles = await response.json();

// 排序：Pin 优先，然后按日期降序
articles.sort((a, b) => {
    // Pin 比较（true 排在前面）
    if (a.pin && !b.pin) return -1;
    if (!a.pin && b.pin) return 1;
    
    // 日期比较（降序）
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    return dateB - dateA;
});

// 只展示前 4 篇
const featuredArticles = articles.slice(0, 4);

// 动态渲染 HTML
container.innerHTML = featuredArticles.map(article => `
    <article class='article-card'>
        <h3>${article.title}</h3>
        <p>${article.date} | ${article.category}</p>
    </article>
`).join('');
```

#### 4. MkDocs Hooks 配置

```yaml
# mkdocs.yml
hooks:
  - hooks.py  # 在构建时自动执行
```

**Hooks 触发时机：**
- `on_pre_build(config)` - 每次 `mkdocs build` 前执行
- `on_serve(server, config, builder)` - 每次 `mkdocs serve` 启动时执行

## 为什么新方式可行

### 1. 分离数据与展示

| 层次 | 职责 | 技术 |
|------|------|------|
| **数据层** | 读取文章元数据 | Python (hooks.py) |
| **存储层** | 保存结构化数据 | JSON 文件 |
| **展示层** | 动态排序和渲染 | JavaScript |

### 2. 利用构建时机

- **MkDocs 构建时**：Python 有文件系统访问权限，可遍历文件
- **浏览器运行时**：JavaScript 只能通过 HTTP 获取数据

### 3. 解决了核心问题

| 问题 | 旧方案 | 新方案 |
|------|--------|--------|
| **读取 front matter** | ❌ Jinja2 无法访问 | ✅ Python YAML 解析 |
| **动态排序** | ❌ 硬编码顺序 | ✅ JS 动态排序 |
| **自动更新** | ❌ 手动维护 | ✅ Hooks 自动生成 |
| **Pin 优先级** | ❌ 无法实现 | ✅ 排序算法实现 |

## 关键文件变更

### 新增文件

1. **hooks.py** - MkDocs 构建钩子
   - 遍历文章目录
   - 解析 front matter
   - 生成 articles.json

2. **docs/posts/articles.json** - 文章元数据（自动生成）
   ```json
   [
     {
       "title": "使用 Tailwind CSS 构建现代化博客主题",
       "date": "2026-01-05",
       "pin": true,  // ← 置顶标记
       "category": "前端开发",
       "url": "/posts/welcome/"
     },
     ...
   ]
   ```

### 修改文件

1. **mkdocs.yml** - 添加 hooks 配置
   ```yaml
   hooks:
     - hooks.py
   ```

2. **custom_theme/home.html** - 使用 fetch 动态加载
   ```javascript
   fetch('/posts/articles.json')
     .then(res => res.json())
     .then(articles => {
       // 排序 + 渲染
     });
   ```

## 文章 Front Matter 配置示例

```markdown
---
title: 使用 Tailwind CSS 构建现代化博客主题
date: 2026-01-05
category: 前端开发
tags:
  - Tailwind
  - CSS
  - 博客
reading_time: 5
pin: true  # ← 设置为置顶文章
---

# 文章内容...
```

## 总结

**核心原理：**
- MkDocs 模板引擎（Jinja2）无法直接访问 Markdown 文件的 front matter
- 需要在 **构建时**（Python 环境）解析文章元数据
- 在 **运行时**（浏览器环境）动态加载和排序

**技术栈：**
- **构建时**：Python + YAML 解析 + 文件 I/O
- **运行时**：JavaScript + Fetch API + 动态 DOM 操作

**优势：**
- ✅ 零硬编码，完全数据驱动
- ✅ 新增文章自动识别
- ✅ Pin 属性灵活控制
- ✅ 排序逻辑可扩展

**适用场景：**
任何需要在 MkDocs 中动态展示、排序、筛选文章的场景。
